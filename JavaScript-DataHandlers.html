<script>


function openConfirmationModal(formId) {
  try {
    const form = document.getElementById(formId);
    const subType = document.getElementById('adType').value;
    
    form.querySelectorAll('.field-error-message').forEach(el => {
      el.textContent = '';
      el.style.display = 'none';
    });

    form.querySelectorAll('.field-error-message').forEach(el => el.remove());
    if (subType === '테스트 광고') {
      const selectionInput = form.querySelector('[name="선택항목"]');
      // ▼▼▼ [수정] 'CPA TRACKER'일 때도 URL 유효성 검사 실행 ▼▼▼
      if (selectionInput && (selectionInput.value === '서버 연동' || selectionInput.value === 'CPA TRACKER')) {
        const hasAtLeastOneUrl = ['URL_기본', 'URL_AOS', 'URL_IOS', 'URL_PC']
          .some(name => {
            const input = form.querySelector(`[name="${name}"]`);
            return input && input.value.trim() !== '';
          });

        if (!hasAtLeastOneUrl) {
          const urlDefaultInput = form.querySelector('[name="URL_기본"]');
          if (urlDefaultInput) {
            const parentGroup = urlDefaultInput.closest('.form-group');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'field-error-message';
            errorDiv.textContent = 'URL 항목 4개 중 하나 이상은 반드시 입력해야 합니다.';
            errorDiv.style.display = 'block';
            parentGroup.appendChild(errorDiv);
            urlDefaultInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
          return;
        }
      }
      // ▲▲▲ [수정] ▲▲▲
    }

    if (subType === '애드네트워크 연동형') {
        const isOneKeyEntered = ['매체키_기본', '매체키_AOS', '매체키_IOS', '매체키_PC']
            .some(name => form.querySelector(`[name="${name}"]`)?.value.trim());
        
        if (!isOneKeyEntered) {
            showMessage('하나 이상의 매체키를 입력해야 합니다.', 'error');
            return;
        }
    }

    const urlValidationTypes = ['CPA S2S', 'CPA TRACKER', 'CPC', 'CPA COUPON'];
    if (urlValidationTypes.includes(subType)) {
      const hasAtLeastOneUrl = ['URL_기본', 'URL_AOS', 'URL_IOS', 'URL_PC']
        .some(name => {
          const input = form.querySelector(`[name="${name}"]`);
          return input && input.offsetParent !== null && input.value.trim() !== '';
        });

      if (!hasAtLeastOneUrl) {
        showMessage('하나 이상의 URL을 입력해야 합니다.', 'error');
        return;
      }
    }



   const volumeOsSelector = form.querySelector('#volume-os-selector');
    if (volumeOsSelector) {
        const selectedOses = (form.querySelector('[name="물량 OS 선택"]')?.value || '').split(',').filter(String);
        if (selectedOses.length === 0) {
            showMessage('물량 OS를 하나 이상 선택해주세요.', 'error');
            volumeOsSelector.scrollIntoView({ behavior: 'smooth', block: 'center' });
            return;
        }

        let allVolumesValid = true;
        selectedOses.forEach(os => {
            const totalInput = form.querySelector(`[name="총물량_${os}"]`);
            const dailyInput = form.querySelector(`[name="일물량_${os}"]`);
            if (!totalInput?.value.trim() || !dailyInput?.value.trim()) {
                allVolumesValid = false;
            }
        });

        if (!allVolumesValid) {
            showMessage('선택된 OS의 총물량과 일물량을 모두 입력해주세요.', 'error');
            const totalVolumeError = form.querySelector('#총물량_error');
            if (totalVolumeError) totalVolumeError.closest('.form-group').scrollIntoView({ behavior: 'smooth', block: 'center' });
            return;
        }
    } else { // 기존 로직 (volume_split을 사용하지 않는 타입들)
        const volumeValidationTypes = ['CPA S2S', 'CPA TRACKER', 'CPA SUBSCRIBE', 'CPC', '애드네트워크 연동형'];
        if (volumeValidationTypes.includes(subType)) {
            const checkVolume = (baseName) => {
                return ['통합', 'AOS', 'IOS'].some(subName => form.querySelector(`[name="${baseName}_${subName}"]`)?.value.trim());
            };
            if (!checkVolume('총물량') || !checkVolume('일물량')) {
                 showMessage('총물량 및 일물량 항목 중 하나 이상을 입력해야 합니다.', 'error');
                 return;
            }
        }
    }

    if (!form.checkValidity()) {
      showMessage('모든 필수 항목(*)을 입력해주세요.', 'error');
      form.reportValidity();
      return;
    }
    
const formData = new FormData(form);
currentFormData = {};

    const selectedOsesForVolume = volumeOsSelector ? (form.querySelector('[name="물량 OS 선택"]')?.value || '').split(',').filter(String) : [];

    for (const [key, value] of formData.entries()) {
      if (!value) continue; // 빈 값은 건너뜁니다.

      // volume-os-selector UI가 있을 때만 총물량/일물량 필터링을 적용
      if (volumeOsSelector && (key.startsWith('총물량_') || key.startsWith('일물량_'))) {
        const osType = key.split('_')[1];
        if (selectedOsesForVolume.includes(osType)) {
          currentFormData[key] = value;
        }
      } else if (key.startsWith('URL_')) {
          if (subType === '멀티미션') {
           currentFormData[key] = value;
           continue; // '멀티리워드'일 경우, 이 필드를 저장하고 다음으로 넘어갑니다.
         }
        if (subType === '테스트 광고') {
            currentFormData[key] = value;
            continue; // 테스트 광고는 OS 필터링 없이 바로 다음으로 넘어감
        }
        // (URL 관련 로직은 기존과 동일)
        const osType = key.split('_')[1];
        let isVisible = false;
        const osDropdownValue = form.querySelector('[name="OS_DROPDOWN"]')?.value || '';
        const osCheckboxValue = form.querySelector('[name="OS_CHECKBOX"]')?.value || '';

         const osSelectValue = form.querySelector('[name="OS"]')?.value || '';

         if (osDropdownValue) {
           if (osType === 'AOS' && (osDropdownValue === 'AOS' || osDropdownValue === '전체')) isVisible = true;
           else if (osType === 'IOS' && (osDropdownValue === 'IOS' || osDropdownValue === '전체')) isVisible = true;
         } else if (osCheckboxValue) {
           if (osType === 'AOS' && (osCheckboxValue.includes('AOS') || osCheckboxValue.includes('전체'))) isVisible = true;
           else if (osType === 'IOS' && (osCheckboxValue.includes('IOS') || osCheckboxValue.includes('전체'))) isVisible = true;
           else if (osType === 'PC' && (osCheckboxValue.includes('PC') || osCheckboxValue.includes('전체'))) isVisible = true;
         } else if (osSelectValue) { // '멀티리워드'의 OS select 값을 확인하는 조건 추가
           if (osType === 'AOS' && (osSelectValue === 'AOS' || osSelectValue === '전체')) isVisible = true;
           else if (osType === 'IOS' && (osSelectValue === 'IOS' || osSelectValue === '전체')) isVisible = true;
         }
        
        if (osType === '기본') isVisible = true;

        if (isVisible) {
          currentFormData[key] = value;
        }
      } else {
        // 그 외 모든 필드는 그대로 저장 ('멀티리워드'의 총물량 필드가 여기에 해당)
        currentFormData[key] = value;
      }
    }

    const mediumConsolidationTypes = ['CPA S2S', 'CPI', 'CPA TRACKER', 'CPA SUBSCRIBE', 'CPC', '애드네트워크 연동형', 'CPQ'];
    if (mediumConsolidationTypes.includes(subType)) {
      if (currentFormData['집행매체1'] === '쿠키오븐') {
        currentFormData['집행매체2'] = currentFormData['집행매체2_쿠키오븐'];
      } else if (currentFormData['집행매체1'] === '애디슨 네트워크') {
        if (currentFormData['집행매체2_애디슨'] === '특정 매체만 진행') {
          currentFormData['집행매체2'] = currentFormData['집행매체2_애디슨_특정'];
        } else {
          currentFormData['집행매체2'] = currentFormData['집행매체2_애디슨'];
        }
      }
    }
    
    const osConsolidationTypes = ['CPA S2S', 'CPA TRACKER', 'CPA SUBSCRIBE', 'CPC', '애드네트워크 연동형'];
    if (osConsolidationTypes.includes(subType)) {
      if (currentFormData['OS_DROPDOWN']) {
        currentFormData['OS'] = currentFormData['OS_DROPDOWN'];
      } else if (currentFormData['OS_CHECKBOX']) {
        currentFormData['OS'] = currentFormData['OS_CHECKBOX'];
      }
    }
    
    if (subType === '쿠키오븐 스마트스토어 CPS') {
      currentFormData['태깅'] = '구매형';
      const actionAmount = currentFormData['액션명'];
      if(actionAmount && !isNaN(actionAmount)) {
        currentFormData['액션명'] = `${actionAmount}만원 이상 구매`;
      }
    }
    

    const fieldsToEscape = ['특이사항 메모장', '문구 - 타이틀', '문구 - 서브', '문구 - 상세화면 상단 타이틀', '문구 - 서브1 상단', '문구 - 서브1 하단', '문구 - 서브2', '가이드 메세지', '버튼 메세지'];
    let summaryHtml = '<table>';

    for (const key in currentFormData) {
      if (!key.startsWith('OS_') && !key.startsWith('집행매체2_')) {
        let value = currentFormData[key];
        let displayValue = String(value);

        // 지정된 필드에 대해서만 HTML 태그를 안전한 텍스트로 변환
        if (fieldsToEscape.includes(key)) {
          displayValue = displayValue.replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }
        
        if (subType === '멀티미션' && key === '미션 정보 붙여넣기') {
          const missionTableHtml = generateMissionTableHtml(value);
          summaryHtml += `<tr><th>${key}</th><td>${missionTableHtml}</td></tr>`;
        } else {
          summaryHtml += `<tr><th>${key}</th><td>${displayValue.replace(/\n/g, '<br>')}</td></tr>`;
        }
      }
    }
    summaryHtml += '</table>';
    
    let modalTitle = '입력 내용 확인';
    const medium1 = currentFormData['집행매체1'];
    const medium2 = currentFormData['집행매체2'];
    let os = currentFormData['OS'] || '';
    
    if (subType === '테스트 광고') {
        modalTitle = `[테스트 광고 등록 요청] ${currentFormData['캠페인명']}_${currentFormData['집행매체1']}`;
    } else if (subType === '네이버페이 스마트스토어 CPS') {
        const cpsTagging = currentFormData['태깅'];
        const boostingTagging = currentFormData['부스팅 CPC 광고 태깅'];
        const brand = currentFormData['브랜드'];
        let actionName = currentFormData['액션명'];  
        if(actionName && !isNaN(actionName)) {  
          actionName = `${actionName}만원 이상 구매`;
        }

        const cpsSubject = `[${cpsTagging}] ${brand}_${actionName}_네이버페이`;
        const boostingSubject = `[CPC_${cpsTagging}_${boostingTagging}] ${brand}_${actionName}_네이버페이`;
        
        modalTitle = `${cpsSubject} / ${boostingSubject}`;

    } else if (subType === '네이버페이 CPS구매확정형_금액X') { 
        const brand = currentFormData['브랜드'] || '';
        
        // 본광고 제목: [태깅] 브랜드_구매확정형_네이버페이
        const cpsSubject = `[일반_브랜드펀딩_구매확정형] ${brand}_구매확정형_네이버페이`;
        
        // 부스팅광고 제목: [태깅] 브랜드_구매확정형_네이버페이
        const boostingSubject = `[CPC_일반_브랜드펀딩_구매확정형_부스팅] ${brand}_구매확정형_네이버페이`;
        
        modalTitle = `${cpsSubject} / ${boostingSubject}`;
    } else if (subType === '네이버페이 입점비') {
        const cpcTitle = `[CPC_입점비] ${currentFormData['CPC 입점비 문구 - 타이틀']}_네이버페이`;

        if (currentFormData['네이버페이 입점비 본 광고 신규 등록 여부'] === '등록 O') {
            const mainAdTagging = currentFormData['태깅'];
            let mainAdParts = [ currentFormData['브랜드'], currentFormData['액션명'], currentFormData['집행매체1'] ];
            
            const mainAdMedium2 = currentFormData['집행매체2'];
            const mainAdOS = currentFormData['OS'] || '';
            
            let medium2Part = '';
            if (currentFormData['집행매체1'] !== '네이버페이' && mainAdMedium2 && mainAdMedium2 !== '전체') {
                medium2Part = mainAdMedium2;
            }
            mainAdParts.push(medium2Part);
            
            let osPart = '';
            if (!((currentFormData['집행매체1'] === '애디슨 네트워크' || currentFormData['집행매체1'] === '쿠키오븐') && (mainAdOS === '전체' || mainAdOS === '모두'))){
               osPart = mainAdOS;
            }
            mainAdParts.push(osPart);

            const mainAdSubject = `[${mainAdTagging}] ` + mainAdParts.filter(Boolean).join('_');
            modalTitle = `[복합 요청] ${mainAdSubject} / ${cpcTitle}`;
        } else {
            modalTitle = cpcTitle;
        }
    } else if (['CPA S2S', 'CPA TRACKER', 'CPC', 'CPA SUBSCRIBE', 'CPQ'].includes(subType)) {
        let medium2Part = '';
        if (medium1 === '네이버페이' || ((medium1 === '쿠키오븐' || medium1 === '애디슨 네트워크') && medium2 === '전체')) {
            medium2Part = '';
        } else {
            medium2Part = medium2;
        }
        let osPart = '';
        if ((medium1 === '애디슨 네트워크' || medium1 === '쿠키오븐') && (os === '전체' || os === '모두')) {
            osPart = '';
        } else if (medium1 === '네이버페이') {
            if (os === '전체' || os === '모두') {
                osPart = '';
            } else {
                osPart = os.split(',').map(function(item) { return item.trim() === 'AOS+IOS' ? '모바일' : item.trim(); }).join(',');
            }
        } else {
            osPart = os;
        }
        const underscoreParts = [ currentFormData['브랜드'], currentFormData['액션명'], medium1, medium2Part, osPart ].filter(Boolean);
        modalTitle = `[${currentFormData['태깅']}] ` + underscoreParts.join('_');
    } else if (subType === 'CPI') {
        let medium2Part = '';
        if ((medium1 === '쿠키오븐' || medium1 === '애디슨 네트워크') && medium2 === '전체') {
          medium2Part = '';
        } else {
          medium2Part = medium2;
        }
        const underscoreParts = [ currentFormData['브랜드'], medium1, medium2Part, 'AOS' ].filter(Boolean);
        modalTitle = '[설치형] ' + underscoreParts.join('_');
    
    } else if (subType === 'CPA COUPON') {
        let osPart = '';
        if (os === '전체' || os === '모두') {
            osPart = '';
        } else {
            osPart = os.split(',').map(function(item) { return item.trim() === 'AOS+IOS' ? '모바일' : item.trim(); }).join(',');
        }
        const underscoreParts = [ currentFormData['브랜드'], currentFormData['액션명'], '네이버페이', osPart ].filter(Boolean);
        modalTitle = `[${currentFormData['태깅']}] ` + underscoreParts.join('_');
        
    } else if (subType === '완전 정률 - 쿠키오븐 스마트스토어 CPS') {
        const tagging = '[구매형]'; 
        const brand = currentFormData['브랜드'] || '브랜드없음'; 
    const os = currentFormData['OS'] === '전체' ? '' : currentFormData['OS'];
    
    const underscoreParts = [brand, '정률', '쿠키오븐', os].filter(Boolean);
            modalTitle = `${tagging} ${underscoreParts.join('_')}`;
      
  } else {
        const tagging = currentFormData['태깅'] ? `[${currentFormData['태깅']}]` : '';
        const underscoreParts = [ currentFormData['브랜드'], currentFormData['액션명'], currentFormData['집행매체1'], currentFormData['집행매체2'], currentFormData['OS'] ].filter(Boolean);
        modalTitle = tagging;
        if (underscoreParts.length > 0) {
          modalTitle += (modalTitle ? ' ' : '') + underscoreParts.join('_');
        }
    }
    
    document.getElementById('modalTitle').textContent = modalTitle || '입력 내용 확인';
    document.getElementById('modalSummary').innerHTML = summaryHtml;
    
    const finalSubmitBtn = document.getElementById('finalSubmitBtn');
    const newBtn = finalSubmitBtn.cloneNode(true);
    finalSubmitBtn.parentNode.replaceChild(newBtn, finalSubmitBtn);
    
    newBtn.addEventListener('click', submitNewAdRequest);

    document.getElementById('confirmationModal').style.display = 'flex';
    window.addEventListener('keydown', handleEscapeForConfirmationModal);

  } catch (error) {
    alert("미리보기를 생성하는 중 오류가 발생했습니다. 개발자 콘솔(F12 > Console 탭)에서 상세 오류를 확인해주세요.\n\n오류 메시지: " + error.message);
    setLoading(false); // 로딩 중이었다면 해제
  }
  // ▲▲▲▲▲ [수정] ▲▲▲▲▲
}


function submitNewAdRequest() {
    currentFormData.ccRecipients = document.getElementById('ccRecipients').value.trim(); // 이 줄 추가
    const subType = document.getElementById('adType').value;
    setLoading(true);
    closeConfirmationModal();
    google.script.run
        .withSuccessHandler(function(response) {
            setLoading(false);
            if (response.success) {
                showMessage(response.message, 'success');
                alert(response.message); // ▼▼▼▼▼ [추가] ▼▼▼▼▼
                document.getElementById('adForm').innerHTML = '';
                document.getElementById('adType').value = '';
            } else {
                showMessage(response.message, 'error');
            }
        })
        .withFailureHandler(handleError)
        .submitData(currentFormData, subType);
}

function loadAdData() {
  const adId = document.getElementById('loadAdId').value.trim();
  if (!adId) { showMessage('불러올 광고 ID를 입력해주세요.', 'error'); return; }
  setLoading(true);
  
  // 폼 데이터가 로드되었는지 확인하는 로직 추가
  if (!allFormFieldsData) {
    // 데이터가 없으면 먼저 전체 폼 데이터를 불러옵니다.
    google.script.run
      .withSuccessHandler(function(data) {
        allFormFieldsData = data; // 전역 변수에 데이터 저장
        // 폼 데이터 로딩이 완료된 후에 광고 데이터 불러오기 실행
        fetchAdDataById(adId); 
      })
      .withFailureHandler(handleError)
      .getAllFormFields();
  } else {
    // 데이터가 이미 있으면 바로 광고 데이터 불러오기 실행
    fetchAdDataById(adId);
  }
}

function fetchAdDataById(adId) {
  isDataLoading = true;
  google.script.run
    .withSuccessHandler(function(adData) {
      setLoading(false);
      if (adData) {
        populateFormWithData(adData);
      } else {
        showMessage(`ID '${adId}'에 해당하는 광고를 찾을 수 없습니다.`, 'error');
        isDataLoading = false;
      }
    })
    .withFailureHandler(function(error) {
      handleError(error);
      isDataLoading = false;
    })
    .getAdDataById(adId);
}

function populateFormWithData(data) {
    let adType = data['광고 타입'];
    if (!adType) {
        showMessage('불러온 데이터에 광고 타입 정보가 없습니다.', 'error');
        isDataLoading = false;
        return;
    }
    // 하위 호환성: 시트에 '멀티리워드'로 저장된 경우 '멀티미션'으로 처리
    if (adType === '멀티리워드') adType = '멀티미션';
    showSection('adSection');
    const adTypeSelect = document.getElementById('adType');
    adTypeSelect.value = adType;

    loadForm('광고', adType, data);
    const form = document.getElementById('adForm');

    setTimeout(function() {
        fillForm(form, data);

        // ▼▼▼▼▼ [수정] 캠페인 키(매체키) 필드 갱신 로직을 다시 추가합니다. ▼▼▼▼▼
        if (adType === '애드네트워크 연동형') {
            setTimeout(function() {
                const osDropdown = form.querySelector('[name="OS_DROPDOWN"]');
                if (osDropdown && osDropdown.offsetParent !== null) {
                    osDropdown.dispatchEvent(new Event('change', { bubbles: true }));
                }
                const osCheckboxGroup = form.querySelector('[name="OS_CHECKBOX"]')?.closest('.form-group');
                if (osCheckboxGroup && osCheckboxGroup.offsetParent !== null) {
                    const anyCheckbox = osCheckboxGroup.querySelector('input[type="checkbox"]');
                    if (anyCheckbox) anyCheckbox.dispatchEvent(new Event('change', { bubbles: true }));
                }

                const mediaKeyFields = ['매체키_기본', '매체키_AOS', '매체키_IOS', '매체키_PC'];
                mediaKeyFields.forEach(key => {
                    if (data[key]) {
                        const input = form.querySelector(`[name="${key}"]`);
                        if (input) {
                            input.value = data[key];
                        }
                    }
                });
            }, 100);
        }
        // ▲▲▲▲▲ [수정] ▲▲▲▲▲

        if (adType === '네이버페이 입점비') {
            const registrationToggleSelect = form.querySelector('[name="네이버페이 입점비 본 광고 신규 등록 여부"]');
            if (registrationToggleSelect) {
                registrationToggleSelect.dispatchEvent(new Event('change', { bubbles: true }));
            }
            const mainAdTypeSelect = form.querySelector('[name="본 광고 타입"]');
            if (mainAdTypeSelect) {
                mainAdTypeSelect.dispatchEvent(new Event('change', { bubbles: true }));
            }
        } else if (adType === '멀티미션') {
            const domesticCampaignIdInput = form.querySelector('[name="국내 캠페인 ID (중복 제거 필요 시 기재)"]');
            if (domesticCampaignIdInput) {
                domesticCampaignIdInput.dispatchEvent(new Event('input', { bubbles: true }));
            }
            const missionTextarea = form.querySelector('[name="미션 정보 붙여넣기"]');
            if (missionTextarea) {
                missionTextarea.dispatchEvent(new Event('input', { bubbles: true }));
            }
            const titleInput = form.querySelector('[name="타이틀 문구(목록)"]');
            if (titleInput) {
                titleInput.dispatchEvent(new Event('input', { bubbles: true }));
            }
        }
    
        showMessage('데이터를 성공적으로 불러왔습니다. 수정 후 등록해주세요.', 'success');
        isDataLoading = false; // ▼▼▼▼▼ 수정: 모든 로딩 완료 후 자동 계산 허용 ▼▼▼▼▼
    }, 300);
}

function fillForm(targetElement, data) {
     const adType = data['광고 타입'];

     // ▼▼▼ [수정] 시트의 긴 이름과 폼의 짧은 이름을 연결하는 맵 객체를 추가합니다. ▼▼▼
     const headerToFieldNameMap = {
       '완료 이벤트 조건(event_parameters JSON 파라미터)': '완료 이벤트 조건(JSON)',
       '완료 이벤트 조건 (개별 파라미터)': '완료 이벤트 조건(개별)'
     };
     
     for (const key in data) {
         if (!data.hasOwnProperty(key)) continue;
         const value = data[key];
         
         // 맵을 사용하여 시트 이름(key)에 맞는 폼 필드 이름(fieldName)을 찾습니다.
         const fieldName = headerToFieldNameMap[key] || key;
         
         if (key === '가이드 메세지' && (adType === 'CPA SUBSCRIBE' || adType === 'CPA SUBSCRIBE 후지급')) {
             const element = targetElement.querySelector(`[name="${fieldName}"]`);
             if (element) {
                 element.value = value;
                 continue;  
             }
         }
 
if (key === '집행매체2') {
             const medium1Value = data['집행매체1'];
             // const adType = data['광고 타입']; // 이미 위에서 정의했으므로 주석 처리

             if (medium1Value === '쿠키오븐') {
                 // 광고 타입에 따라 다른 name 속성을 가진 요소를 찾도록 수정
                 const selector = (adType === '쿠키오븐 스마트스토어 CPS' || adType === '완전 정률 - 쿠키오븐 스마트스토어 CPS')
                                  ? '[name="집행매체2"]'
                                  : '[name="집행매체2_쿠키오븐"]';
                 const el = targetElement.querySelector(selector);
                 if (el) {
                     el.value = value;
                     // change 이벤트를 발생시켜 관련된 다른 로직(있다면)도 트리거
                     el.dispatchEvent(new Event('change', { bubbles: true }));
                 }
             } else if (medium1Value === '애디슨 네트워크') {
                 // 애디슨 네트워크 관련 로직 (기존과 동일)
                 const addisonOptions = ['전체', '특정 매체만 진행'];
                 const addisonSelect = targetElement.querySelector('[name="집행매체2_애디슨"]');
                 const addisonSpecificInput = targetElement.querySelector('[name="집행매체2_애디슨_특정"]');
                 if (addisonOptions.includes(value)) {
                     if (addisonSelect) addisonSelect.value = value;
                 } else {
                     if (addisonSelect) addisonSelect.value = '특정 매체만 진행';
                     if (addisonSpecificInput) addisonSpecificInput.value = value;
                 }
                 if (addisonSelect) addisonSelect.dispatchEvent(new Event('change', { bubbles: true }));
             }
             continue; // 집행매체2 처리는 여기서 종료
         }
 
         if (key === 'OS') {
             const osConsolidationTypes = ['애드네트워크 연동형', 'CPA S2S', 'CPA TRACKER', 'CPA SUBSCRIBE', 'CPC', 'CPA COUPON'];
             if (osConsolidationTypes.includes(adType)) {
                 const medium1Value = data['집행매체1'];
                 if (medium1Value === '쿠키오븐' || medium1Value === '애디슨 네트워크') {
                     const dropdown = targetElement.querySelector('[name="OS_DROPDOWN"]');
                     if (dropdown) {
                         dropdown.value = value;
                         dropdown.dispatchEvent(new Event('change', { bubbles: true }));
                     }
                 } else if (medium1Value === '네이버페이') {
                     const osCheckboxEl = targetElement.querySelector('[name="OS_CHECKBOX"]');
                     const checkboxContainer = osCheckboxEl ? osCheckboxEl.closest('.form-group') : null;
                     if (checkboxContainer) {
                         const allCb = checkboxContainer.querySelector('label:first-child input');
                         const allOptions = Array.from(checkboxContainer.querySelectorAll('input[value]'));
                         if (String(value) === '전체' || String(value) === '모두') {
                             if (allCb) {
                                 allCb.checked = true;
                                 allCb.dispatchEvent(new Event('change', { bubbles: true }));
                             }
                         } else {
                             const osValues = String(value).split(',');
                             allOptions.forEach(function(cb) { cb.checked = osValues.includes(cb.value); });
                             if (allCb) { allCb.checked = allOptions.every(cb => cb.checked); }
                             osCheckboxEl.value = value;
                             if (allOptions.length > 0) allOptions[allOptions.length - 1].dispatchEvent(new Event('change', { bubbles: true }));
                         }
                     }
                 }
                 continue;
             }
         }

         if (key === '총물량' && adType === '완전 정률 - 쿠키오븐 스마트스토어 CPS') {
             // ID를 사용하여 정확한 요소 선택
             const numInputElement = targetElement.querySelector('#num-input-총물량'); // ID로 number input 선택
             const unlimitedCbElement = targetElement.querySelector('#unlimited-cb-총물량'); // ID로 checkbox 선택
             const hiddenInputElement = targetElement.querySelector('[name="총물량"]'); // hidden input 선택 (값 동기화용)

             if (numInputElement && unlimitedCbElement && hiddenInputElement) {
                 if (value === '무제한') {
                     unlimitedCbElement.checked = true;
                     numInputElement.value = ''; // 보이는 input 비우기
                     numInputElement.disabled = true;
                     hiddenInputElement.value = '무제한'; // hidden input 값 설정
                 } else {
                     unlimitedCbElement.checked = false;
                     numInputElement.value = value; // 보이는 input에 값 설정
                     numInputElement.disabled = false;
                     hiddenInputElement.value = value; // hidden input 값 설정
                 }
                 // 상태 변경 후 체크박스 change 이벤트 트리거 (중요! disabled 상태 업데이트 등)
                 unlimitedCbElement.dispatchEvent(new Event('change', { bubbles: true }));
             }
             continue; // "완전 정률..." 타입의 총물량 처리는 여기서 종료 (아래 기본 로직 실행 방지)
         }
          
         // [수정] key 대신 fieldName으로 엘리먼트를 찾습니다.
         const element = targetElement.querySelector(`[name="${fieldName}"]`);
         if (!element) continue;

         // [수정] key 대신 fieldName으로 엘리먼트를 찾습니다.
         const groupCheckbox = targetElement.querySelector(`input[type="checkbox"][name="${fieldName}"]`);
         if (groupCheckbox && value) {
             groupCheckbox.checked = true;
             groupCheckbox.dispatchEvent(new Event('change', { bubbles: true }));
         }
          
         if (key === 'CPC 입점비 OS') {
             const checkboxGroup = element.closest('.form-group');
             if (checkboxGroup) {
                 const allCb = checkboxGroup.querySelector('input[type="checkbox"]:not([value])');
                 const allOptions = Array.from(checkboxGroup.querySelectorAll('input[value]'));
                 if (allCb) allCb.checked = false;
                 allOptions.forEach(cb => cb.checked = false);
 
                 if (String(value) === '전체' || String(value) === '모두') {
                     if (allCb) {
                         allCb.checked = true;
                         allCb.dispatchEvent(new Event('change', { bubbles: true }));
                     }
                 } else {
                     const osValues = String(value).split(',');
                     allOptions.forEach(function(cb) {
                         cb.checked = osValues.includes(cb.value);
                     });
                     if (allOptions.length > 0) {
                         allOptions[allOptions.length - 1].dispatchEvent(new Event('change', { bubbles: true }));
                     }
                 }
             }
             continue;
         }
 
         if (key.endsWith('광고주') || key.endsWith('거래처')) {
             const container = element.closest('.searchable-dropdown');
             if (container) {
                 const hiddenInput = container.querySelector(`input[type="hidden"][name="${fieldName}"]`);
                 const selectedValueInput = container.querySelector('.selected-value');
                 if (hiddenInput && selectedValueInput) {
                     hiddenInput.value = value;
                     selectedValueInput.value = value;
                     hiddenInput.dispatchEvent(new Event('change', { bubbles: true }));
                 }
             }
             continue;
         }
          
         const formGroup = element.closest('.form-group');
          
         const wrapper = formGroup ? formGroup.querySelector('.input-wrapper') : null;
         const visibleDatePicker = wrapper ? wrapper.querySelector('input[data-picker-type="datetime"]') : null;
 
         if (element.type === 'hidden' && visibleDatePicker) {
             const unlimitedCheckbox = wrapper.querySelector('input[type="checkbox"]');
             if (value === '무제한') {
                 visibleDatePicker.disabled = true;
                 visibleDatePicker.value = '무제한';
                 if (visibleDatePicker._flatpickr) visibleDatePicker._flatpickr.clear();
                 if (unlimitedCheckbox) unlimitedCheckbox.checked = true;
             } else if (value) { // 값이 비어있지 않고 '무제한'도 아닐 때만 날짜 설정
                 visibleDatePicker.disabled = false;
                 if (unlimitedCheckbox) unlimitedCheckbox.checked = false;
                 if (visibleDatePicker._flatpickr) {
                     let dateValueToSet = value;
                     if (typeof value === 'string') {
                       dateValueToSet = value.replace('T', ' '); // T를 공백으로 치환
                     }
                     try {
                        visibleDatePicker._flatpickr.setDate(dateValueToSet, false);
                     } catch(e) {
                       console.error("Flatpickr setDate error:", e, "Value:", value);
                       visibleDatePicker.value = value; // flatpickr 오류 시 원본 값 표시
                     }
                 } else {
                     visibleDatePicker.value = value;
                 }
             } else { // 값이 비어있을 때
                 visibleDatePicker.disabled = false;
                 if (unlimitedCheckbox) unlimitedCheckbox.checked = false;
                 if (visibleDatePicker._flatpickr) {
                     visibleDatePicker._flatpickr.clear(); // 날짜 선택기 값 비우기
                 } else {
                     visibleDatePicker.value = ''; // 직접 값 비우기
                 }
             }
             element.value = value;
             continue;
         }

if (key === '총물량') {
             // "완전 정률..." 타입은 자동 계산 없이 직접 값 설정
             if (adType === '완전 정률 - 쿠키오븐 스마트스토어 CPS') {
                 // ID를 사용하여 정확한 요소 선택
                 const numInputElement = targetElement.querySelector('#num-input-총물량');
                 const unlimitedCbElement = targetElement.querySelector('#unlimited-cb-총물량');
                 const hiddenInputElement = targetElement.querySelector('[name="총물량"]');

                 if (numInputElement && unlimitedCbElement && hiddenInputElement) {
                     if (value === '무제한') {
                         unlimitedCbElement.checked = true;
                         numInputElement.value = '';
                         numInputElement.disabled = true;
                         hiddenInputElement.value = '무제한';
                     } else {
                         unlimitedCbElement.checked = false;
                         numInputElement.value = value;
                         numInputElement.disabled = false;
                         hiddenInputElement.value = value;
                     }
                     unlimitedCbElement.dispatchEvent(new Event('change', { bubbles: true }));
                 }
                 continue; // "완전 정률..." 타입의 총물량 처리는 여기서 종료
             }
         }
          
         const numberInput = wrapper ? wrapper.querySelector('input[type="number"]') : null;
         const textInputForUnlimited = wrapper ? wrapper.querySelector('input[type="text"]') : null;
 
         if (element.type === 'hidden' && (numberInput || (textInputForUnlimited && !textInputForUnlimited.dataset.pickerType))) {
             const unlimitedCheckbox = wrapper.querySelector('input[type="checkbox"]');
             const visibleInput = numberInput || textInputForUnlimited;
             if (value === '무제한') {
                 if (unlimitedCheckbox) unlimitedCheckbox.checked = true;
                 visibleInput.disabled = true;
                 visibleInput.value = '';
             } else {
                 if (unlimitedCheckbox) unlimitedCheckbox.checked = false;
                 visibleInput.disabled = false;
                 visibleInput.value = value;
             }
             element.value = value;
             continue;
         }
 
         if (key === '액션명' && adType === '쿠키오븐 스마트스토어 CPS') {
             const numericValue = parseInt(data[key], 10);
             if (!isNaN(numericValue) && element) {
                 element.value = numericValue;
             }
             continue;
         }
 
         if (element.tagName === 'SELECT' && (String(value).toUpperCase() === 'TRUE' || String(value).toUpperCase() === 'FALSE')) {
             element.value = String(value).toUpperCase();
         } else {
             element.value = value;

             if (key === '광고비 R/S율' && adType === '완전 정률 - 쿠키오븐 스마트스토어 CPS') {
                 element.dispatchEvent(new Event('input', { bubbles: true }));
             }
         }
 
         element.dispatchEvent(new Event('change', { bubbles: true }));

         if (element.tagName === 'TEXTAREA') {
           element.dispatchEvent(new Event('input'));
         }
     }
 
     const volumeOsSelector = targetElement.querySelector('#volume-os-selector');
     if (volumeOsSelector && data['물량 OS 선택']) {
         const selectedOses = data['물량 OS 선택'].split(',');
         selectedOses.forEach(os => {
             const checkbox = volumeOsSelector.querySelector(`input[data-target="${os}"]`);
             if (checkbox) {
                 checkbox.checked = true;
                 checkbox.dispatchEvent(new Event('change', { bubbles: true }));
             }
         });
     } else if (volumeOsSelector) {
         ['통합', 'AOS', 'IOS'].forEach(os => {
             if (data[`총물량_${os}`] || data[`일물량_${os}`]) {
                 const checkbox = volumeOsSelector.querySelector(`input[data-target="${os}"]`);
                 if (checkbox) {
                     checkbox.checked = true;
                     checkbox.dispatchEvent(new Event('change', { bubbles: true }));
                 }
             }
         });
     }
 }

function generateMissionTableHtml(text) {
  if (!text || !text.trim()) return '(입력 없음)';

  const missions = text.trim().split('\n').map(line => {
    const columns = line.split('\t');
    return {
      missionName: columns[0] || '',
      eventCode: columns[1] || '',
      userGuide: columns[2] || '',
      price: columns[3] || '',
      time: columns[4] || ''
    };
  });
  
  if (missions.length === 0) return '(입력 없음)';
  
  let totalCost = 0;
  // ▼▼▼ [수정] 테이블 헤더에 '이벤트 코드' 추가 ▼▼▼
  let tableHTML = '<table style="width:100%; border-collapse: collapse; font-size: 12px;"><thead><tr style="background-color:#f8f9fa;">' +
                  '<th style="border: 1px solid #ddd; padding: 6px;">미션</th><th style="border: 1px solid #ddd; padding: 6px;">이벤트 코드</th><th style="border: 1px solid #ddd; padding: 6px;">안내문구</th><th style="border: 1px solid #ddd; padding: 6px;">단가</th><th style="border: 1px solid #ddd; padding: 6px;">소요시간</th></tr></thead><tbody>';

  missions.forEach(mission => {
    // ▼▼▼ [수정] 테이블 행에 'mission.eventCode' 추가 ▼▼▼
    tableHTML += `<tr>
                    <td style="border: 1px solid #ddd; padding: 6px;">${mission.missionName}</td>
                    <td style="border: 1px solid #ddd; padding: 6px;">${mission.eventCode}</td>
                    <td style="border: 1px solid #ddd; padding: 6px;">${mission.userGuide}</td>
                    <td style="border: 1px solid #ddd; padding: 6px;">${mission.price}</td>
                    <td style="border: 1px solid #ddd; padding: 6px;">${mission.time}</td>
                  </tr>`;
    totalCost += parseFloat(mission.price) || 0;
  });

  // ▼▼▼ [수정] colspan을 3으로 변경 ▼▼▼
  tableHTML += `</tbody><tfoot><tr style="font-weight: bold;">
                  <td colspan="3" style="border: 1px solid #ddd; padding: 6px; text-align: right;">단가 총합:</td>
                  <td colspan="2" style="border: 1px solid #ddd; padding: 6px;">${totalCost.toLocaleString()}</td>
                </tr></tfoot></table>`;
  
  return tableHTML;
}

function submitSkip() {
    const adId = document.getElementById('skipAdId').value.trim();
    if (!adId) { showMessage('광고 ID를 입력해주세요.', 'error'); return; }
    setLoading(true);
    google.script.run
        .withSuccessHandler(function(response) {
            setLoading(false);
            if (response.success) {
                showMessage(response.message, 'success');
                alert(response.message); // ▼▼▼▼▼ [추가] ▼▼▼▼▼
                document.getElementById('skipAdId').value = '';
            } else {
                showMessage(response.message, 'error');
            }
        })
        .withFailureHandler(handleError)
        .processSkip(adId);
}

function submitRejection() {
    const adId = document.getElementById('rejectionAdId').value.trim();
    const reason = document.getElementById('rejectionReason').value.trim();

    if (!adId) {
        showMessage('반려할 광고 ID를 입력해주세요.', 'error');
        return;
    }

    setLoading(true);
    google.script.run
        .withSuccessHandler(function(response) {
            setLoading(false);
            if (response.success) {
                showMessage(response.message, 'success');
                alert(response.message); // ▼▼▼▼▼ [추가] ▼▼▼▼▼
                document.getElementById('rejectionAdId').value = '';
                document.getElementById('rejectionReason').value = '';
            } else {
                showMessage(response.message, 'error');
            }
        })
        .withFailureHandler(handleError)
        .processRejection(adId, reason);
}

function openModificationRequestModal() {
  const form = document.getElementById('modificationRequestForm');
  if (!form.checkValidity()) {
   showMessage('모든 필수 항목을 입력해주세요.', 'error');
   form.reportValidity();
   return;
  }

  const formData = new FormData(form);
  currentFormData = {};

    // ▼▼▼▼▼ [수정] 실제로 화면에 보이는 필드의 값만 수집하도록 로직을 변경합니다. ▼▼▼▼▼
  for (const [key, value] of formData.entries()) {
        if (!value || value.trim() === '') continue;

        const element = form.querySelector(`[name="${key}"]`);
        if (!element) continue;

        // 요소가 실제로 화면에 보이는지(offsetParent가 null이 아닌지) 확인합니다.
        // 기본 항목이거나, 체크박스가 선택되어 화면에 보이는 항목만 포함됩니다.
        if (element.offsetParent !== null) {
            if (currentFormData.hasOwnProperty(key)) {
                if (!Array.isArray(currentFormData[key])) {
                    currentFormData[key] = [currentFormData[key]];
                }
                currentFormData[key].push(value);
            } else {
                currentFormData[key] = value;
            }
        }
  }
    // ▲▲▲▲▲ [수정] ▲▲▲▲▲

  const unlimitedDateFields = [
    '광고 집행 종료 일시',
    '광고 노출 중단 종료일시'
  ];

  unlimitedDateFields.forEach(fieldName => {
    const fieldCheckbox = document.getElementById(`mod-check-${fieldName}`);
    if (fieldCheckbox && fieldCheckbox.checked) {
      const fieldWrapper = form.querySelector(`[name="${fieldName}"]`).closest('.input-wrapper');
      const unlimitedCheckbox = fieldWrapper.querySelector('input[type="checkbox"]');
      if (unlimitedCheckbox && unlimitedCheckbox.checked) {
        currentFormData[fieldName] = '무제한';
      }
    }
  });
  
  const fieldOrder = [
   '주요 요청사항', '대상 캠페인 ID', '대상 광고 ID', '대상 광고명', '예약 반영 시점',
   '광고주 연동 토큰 값', '매체', '단가', '총물량', '리워드', '일물량',
   '광고 집행 시작 일시', '광고 집행 종료 일시', '광고 노출 중단 시작일시', '광고 노출 중단 종료일시', '광고 참여 시작 후 완료 인정 유효기간 (일단위)',
   '트래커', '완료 이벤트 이름', '트래커 추가 정보 입력', 'URL - 기본', 'URL - AOS', 'URL - IOS', 'URL - PC',
      'URL - 네이버페이 CPC 전용', '기본 URL', '상세전용랜딩 URL',
   '소재 경로', '적용 필요 항목',
   '라이브 시작 시간', '라이브 종료 시간', 'adid 타겟팅 모수파일', '데모타겟1', '데모타겟2',
   '2차 액션 팝업 사용', '2차 액션 팝업 이미지 링크', '2차 액션 팝업 타이틀', '2차 액션 팝업 액션 버튼명', '2차 액션 팝업 랜딩 URL',
   '문구 - 타이틀', '문구 - 서브', '문구 - 상세화면 상단 타이틀', '문구 - 서브1 상단', '문구 - 서브1 하단',
   '액션 버튼', '문구 - 서브2', '노출 대상', '기타', '광고 타입별 추가',
   '쿠키오븐 CPS_최소 결제 금액', '쿠키오븐 CPS_파트너 광고주 타입', '쿠키오븐 CPS_파트너 광고주 ID', '쿠키오븐 CPS_참여 경로 유형(app/web)',
   '네이버페이 알림받기_(메타) NF 광고주 연동 타입', '네이버페이 알림받기_(메타) NF 광고주 연동 ID', '네이버페이 알림받기_URL',
   '네이버페이 CPS_본광고_URL', '네이버페이 CPS_본광고_최소 결제 금액', '네이버페이 CPS_본광고_(목록) 리워드 조건 설명', '네이버페이 CPS_본광고_(목록) 리워드 텍스트', '네이버페이 CPS_본광고_(메타) NF 광고주 연동 ID', '네이버페이 CPS_본광고_(메타) 클릭 리워드 지급 금액',
   '네이버페이 CPS_부스팅_복사 필요한 광고 ID', '네이버페이 CPS_부스팅_URL & 상세 전용 랜딩 URL', '네이버페이 CPS_부스팅_문구 - 서브1 하단', '네이버페이 CPS_부스팅_최소 결제 금액', '네이버페이 CPS_부스팅_(목록) 리워드 조건 설명', '네이버페이 CPS_부스팅_부스팅 옵션', '네이버페이 CPS_부스팅_placement 세팅 정보 옵션_추천 세팅 여부', '네이버페이 CPS_부스팅_placement 세팅 정보 기본', '네이버페이 CPS_부스팅_placement 세팅 정보 옵션_카테고리',
   'CPQ_CPQ 뷰', 'CPQ_랜딩 형태', 'CPQ_임배디드 연결 형태', 'CPQ_유튜브 ID / 네이버 TV CODE', 'CPQ_이미지', 'CPQ_이미지 연결 링크', 'CPQ_퀴즈', 'CPQ_정답', 'CPQ_정답 placeholder 텍스트', 'CPQ_오답 alert 메시지', 'CPQ_사전 랜딩(딥링크) 사용', 'CPQ_사전 랜딩 실행 필수', 'CPQ_사전 랜딩 URL', 'CPQ_사전 랜딩 버튼 텍스트', 'CPQ_사전 랜딩 미실행 alert 메시지',
   'CPA SUBSCRIBE_구독 대상 이름', 'CPA SUBSCRIBE_이미지 인식에 사용할 식별자', 'CPA SUBSCRIBE_광고주 계정 식별자1', 'CPA SUBSCRIBE_광고주 계정 식별자2', 'CPA SUBSCRIBE_광고주 계정 식별자3', 'CPA SUBSCRIBE_구독 페이지 랜딩 URL', 'CPA SUBSCRIBE_구독 페이지 랜딩 URL AOS', 'CPA SUBSCRIBE_구독 페이지 랜딩 URL IOS'
  ];

const fieldsToEscape = ['주요 요청사항', '문구 - 타이틀', '문구 - 서브', '문구 - 상세화면 상단 타이틀', '문구 - 서브1 상단', '문구 - 서브1 하단', '문구 - 서브2'];
  let summaryHtml = '<table>';

  fieldOrder.forEach(key => {
    if (currentFormData.hasOwnProperty(key)) {
      let value = currentFormData[key];
      if (Array.isArray(value)) {
        value = value.join(', ');
      }
      
      let displayValue = String(value);
      // 지정된 필드에 대해서만 HTML 태그를 안전한 텍스트로 변환
      if (fieldsToEscape.includes(key)) {
        displayValue = displayValue.replace(/</g, '&lt;').replace(/>/g, '&gt;');
      }

      summaryHtml += `<tr><th>${key.replace(/_/g, ' ')}</th><td>${displayValue.replace(/\n/g, '<br>')}</td></tr>`;
    }
  });
  summaryHtml += '</table>';
  document.getElementById('modalSummary').innerHTML = summaryHtml;

  const modalTitle = `[광고 수정 요청] ${currentFormData['대상 광고명']?.split('\n')[0]}`;
  document.getElementById('modalTitle').textContent = modalTitle;
  document.getElementById('modalSummary').innerHTML = summaryHtml;

  const finalSubmitBtn = document.getElementById('finalSubmitBtn');
  const newBtn = finalSubmitBtn.cloneNode(true);
  finalSubmitBtn.parentNode.replaceChild(newBtn, finalSubmitBtn);
  newBtn.addEventListener('click', submitModificationRequest);

  document.getElementById('confirmationModal').style.display = 'flex';
  window.addEventListener('keydown', handleEscapeForConfirmationModal);
}

function submitModificationRequest() {
    currentFormData.ccRecipients = document.getElementById('ccRecipients').value.trim();
    setLoading(true);
    closeConfirmationModal();
    google.script.run
        .withSuccessHandler(function(response) {
            setLoading(false);
            if (response.success) {
                showMessage(response.message, 'success');
                alert(response.message); // ▼▼▼▼▼ [추가] ▼▼▼▼▼
                document.getElementById('modificationRequestForm').reset();
                const adTypeSpecificContainer = document.getElementById('adTypeSpecificContainer');
                if (adTypeSpecificContainer) adTypeSpecificContainer.innerHTML = '';
                buildModificationRequestForm();
            } else {
                showMessage(response.message, 'error');
            }
        })
        .withFailureHandler(handleError)
        .submitModificationRequest(currentFormData);
}

  function loadModificationData() {
    const modId = document.getElementById('loadModificationId').value.trim();
    if (!modId) { showMessage('불러올 수정 ID를 입력해주세요.', 'error'); return; }
    setLoading(true);
    google.script.run
      .withSuccessHandler(function(data) {
        setLoading(false);
        if (data) {
          populateModificationFormWithData(data);
        } else {
          showMessage(`수정 ID '${modId}'에 해당하는 데이터를 찾을 수 없습니다.`, 'error');
        }
      })
      .withFailureHandler(handleError)
      .getModificationDataById(modId);
  }

  function populateModificationFormWithData(data) {
 showSection('modificationRequestSection');

 setTimeout(() => {
   const form = document.getElementById('modificationRequestForm');
   form.reset();
  
   form.querySelectorAll('#modificationFieldsContainer .checkbox-field-group').forEach(group => {
     const checkbox = group.querySelector('input[type="checkbox"]');
     const fieldContainer = group.querySelector('.modification-field');
     if (checkbox) checkbox.checked = false;
     if (fieldContainer) fieldContainer.style.display = 'none';
   });

   for (const key in data) {
     if (data.hasOwnProperty(key) && data[key] !== null && String(data[key]).trim() !== '') {
       const elements = form.querySelectorAll(`[name="${key}"]`);
       if (elements.length === 0) continue;

              const mainCheckbox = document.getElementById(`mod-check-${key}`);
              if (mainCheckbox) {
                  mainCheckbox.checked = true;
                  mainCheckbox.dispatchEvent(new Event('change'));
              }
      
       const element = elements[0];
       if (element.type === 'checkbox') {
                  const values = String(data[key]).split(',').map(v => v.trim());
                  elements.forEach(cb => { if(values.includes(cb.value)) cb.checked = true; });
              } else {
                  element.value = data[key];
              }
     }
   }
  
      // ▼▼▼▼▼ [추가] 하위 URL 필드에 값이 있으면 상위 체크박스를 활성화하는 로직 ▼▼▼▼▼
      if (data['기본 URL'] || data['상세전용랜딩 URL']) {
          const cpcUrlCheckbox = document.getElementById('mod-check-URL - 네이버페이 CPC 전용');
          if (cpcUrlCheckbox) {
              cpcUrlCheckbox.checked = true;
              cpcUrlCheckbox.dispatchEvent(new Event('change'));
          }
          // 하위 필드 값을 다시 한번 채워줍니다.
          if(data['기본 URL']) form.querySelector('[name="기본 URL"]').value = data['기본 URL'];
          if(data['상세전용랜딩 URL']) form.querySelector('[name="상세전용랜딩 URL"]').value = data['상세전용랜딩 URL'];
      }
      // ▲▲▲▲▲ [추가] ▲▲▲▲▲
  
   setTimeout(() => {
     for (const key in data) {
       if (data.hasOwnProperty(key) && data[key] !== null && String(data[key]).trim() !== '') {
         const adTypeSpecificElement = form.querySelector(`[name="${key}"]`);
         if (adTypeSpecificElement && adTypeSpecificElement.closest('#adTypeSpecificContainer')) {
           if (adTypeSpecificElement.type === 'checkbox') {
             const values = String(data[key]).split(',').map(v => v.trim());
             form.querySelectorAll(`[name="${key}"]`).forEach(cb => {
               if (values.includes(cb.value)) cb.checked = true;
             });
           } else {
             adTypeSpecificElement.value = data[key];
           }
           if (adTypeSpecificElement.tagName === 'SELECT') {
            adTypeSpecificElement.dispatchEvent(new Event('change'));
           }
         }
       }
     }
   }, 200);

   showMessage('수정 요청 데이터를 불러왔습니다. 수정 후 다시 요청해주세요.', 'success');
 }, 300);
}


function openModificationShareModal() {
  const form = document.getElementById('modificationShareForm');


  const optionalSections = {
    'totalVolumeField': document.querySelector("input[onchange*='totalVolumeField']"),
    'dailyVolumeField': document.querySelector("input[onchange*='dailyVolumeField']"),
    'onOffField': document.querySelector("input[onchange*='onOffField']"),
    'targetAudienceField': document.querySelector("input[onchange*='targetAudienceField']"),
    'imageMaterialField': document.querySelector("input[onchange*='imageMaterialField']") // <-- [추가]
  };

  for (const fieldId in optionalSections) {
    const checkbox = optionalSections[fieldId];
    if (checkbox && !checkbox.checked) {
      const field = document.getElementById(fieldId);
      if (field) {
        const textarea = field.querySelector('textarea');
        if (textarea) {
          textarea.required = false;
        }
      }
    }
  }


  if (!form.checkValidity()) {
    showMessage('모든 필수 항목을 입력해주세요.', 'error');
    form.reportValidity();
    return;
  }
  
  const formData = new FormData(form);
  currentFormData = {};
  let summaryHtml = '<table>';
  
  formData.forEach((value, key) => {
    if (value.trim()) {
      currentFormData[key] = value;
      summaryHtml += `<tr><th>${key}</th><td>${value.replace(/\n/g, '<br>')}</td></tr>`;
    }
  });
  summaryHtml += '</table>';

  const modalTitle = `[광고 수정 공유] ${currentFormData['대상 광고명'].split('\n')[0]}`;
  
  document.getElementById('modalTitle').textContent = modalTitle;
  document.getElementById('modalSummary').innerHTML = summaryHtml;

  const finalSubmitBtn = document.getElementById('finalSubmitBtn');
  // 기존 onclick 핸들러를 제거하고 새로 설정
  const newBtn = finalSubmitBtn.cloneNode(true);
  finalSubmitBtn.parentNode.replaceChild(newBtn, finalSubmitBtn);
  newBtn.addEventListener('click', submitModificationShare);

  document.getElementById('confirmationModal').style.display = 'flex';
  window.addEventListener('keydown', handleEscapeForConfirmationModal);
}

function submitModificationShare() {
    currentFormData.ccRecipients = document.getElementById('ccRecipients').value.trim(); 
    setLoading(true);
    closeConfirmationModal();
    google.script.run
        .withSuccessHandler(function(response) {
            setLoading(false);
            if (response.success) {
                showMessage(response.message, 'success');
                alert(response.message); // ▼▼▼▼▼ [추가] ▼▼▼▼▼
                document.getElementById('modificationShareForm').reset();
                ['totalVolumeField', 'dailyVolumeField', 'onOffField', 'targetAudienceField'].forEach(id => {
                    const field = document.getElementById(id);
                    if(field) field.style.display = 'none';
                });
            } else {
                showMessage(response.message, 'error');
            }
        })
        .withFailureHandler(handleError)
        .submitModificationShare(currentFormData);
}


function openCouponRequestModal() {
  const form = document.getElementById('couponRequestForm');
  if (!form.checkValidity()) {
    showMessage('모든 필수 항목을 입력해주세요.', 'error');
    form.reportValidity();
    return;
  }
  
  const formData = new FormData(form);
  currentFormData = {};
  let summaryHtml = '<table>';
  
  formData.forEach((value, key) => {
    if (value.trim()) {
      currentFormData[key] = value;
      summaryHtml += `<tr><th>${key}</th><td>${value.replace(/\n/g, '<br>')}</td></tr>`;
    }
  });
  summaryHtml += '</table>';

  const modalTitle = `[쿠폰 발급 요청] ${currentFormData['대상 광고명'].split('\n')[0]}`;
  
  document.getElementById('modalTitle').textContent = modalTitle;
  document.getElementById('modalSummary').innerHTML = summaryHtml;

  const finalSubmitBtn = document.getElementById('finalSubmitBtn');
  const newBtn = finalSubmitBtn.cloneNode(true);
  finalSubmitBtn.parentNode.replaceChild(newBtn, finalSubmitBtn);
  newBtn.addEventListener('click', submitCouponRequest);

  document.getElementById('confirmationModal').style.display = 'flex';
  window.addEventListener('keydown', handleEscapeForConfirmationModal);
}


function submitCouponRequest() {
  currentFormData.ccRecipients = document.getElementById('ccRecipients').value.trim(); 
    setLoading(true);
    closeConfirmationModal();
    google.script.run
        .withSuccessHandler(function(response) {
            setLoading(false);
            if (response.success) {
                showMessage(response.message, 'success');
                alert(response.message); // ▼▼▼▼▼ [추가] ▼▼▼▼▼
                document.getElementById('couponRequestForm').reset();
            } else {
                showMessage(response.message, 'error');
            }
        })
        .withFailureHandler(handleError)
        .submitCouponRequest(currentFormData);
}


function submitModificationSkip() {
  const modId = document.getElementById('modSkipId').value.trim();
  if (!modId) {
    showMessage('스킵할 수정 ID를 입력해주세요.', 'error');
    return;
  }
  setLoading(true);
  google.script.run
    .withSuccessHandler(function(response) {
      setLoading(false);
      if (response.success) {
        showMessage(response.message, 'success');
        alert(response.message);
        document.getElementById('modSkipId').value = '';
      } else {
        showMessage(response.message, 'error');
      }
    })
    .withFailureHandler(handleError)
    .processModificationSkip(modId);
}

function submitModificationRejection() {
  const modId = document.getElementById('modRejectionId').value.trim();
  const reason = document.getElementById('modRejectionReason').value.trim();

  if (!modId) {
    showMessage('반려할 수정 ID를 입력해주세요.', 'error');
    return;
  }

  setLoading(true);
  google.script.run
    .withSuccessHandler(function(response) {
      setLoading(false);
      if (response.success) {
        showMessage(response.message, 'success');
        alert(response.message);
        document.getElementById('modRejectionId').value = '';
        document.getElementById('modRejectionReason').value = '';
      } else {
        showMessage(response.message, 'error');
      }
    })
    .withFailureHandler(handleError)
    .processModificationRejection(modId, reason);
}

function openOtherRequestModal() {
  const form = document.getElementById('otherRequestForm');
  if (!form.checkValidity()) {
    showMessage('모든 필수 항목을 입력해주세요.', 'error');
    form.reportValidity();
    return;
  }

  const formData = new FormData(form);
  currentFormData = {};
  let summaryHtml = '<table>';
  
  const fieldOrder = [
      '광고주명', '요청사항', '선택항목', 
      '캠페인명', '캠페인 ID',
      '팝업 노출 시작 일시', '팝업 노출 종료 일시', '팝업 표시 타입', 
      '배너 노출 시작 일시', '배너 노출 종료 일시', '배너 NEW 표시 종료일시',
      '배너 텍스트', '배너 표시 타입', '배너 배경색상', 
      '우선순위', '이미지 경로'
  ];
  
  fieldOrder.forEach(key => {
      if(formData.has(key)) {
          const value = formData.get(key);
          if (value && value.trim()) {
              currentFormData[key] = value;
          }
      }
  });

  const requestType = currentFormData['선택항목'];

  if (requestType === '팝업요청') {
    currentFormData['팝업 그룹'] = '팝업그룹_애디슨_공통';
  } else if (requestType === '배너요청') {
    currentFormData['배너 그룹'] = '배너그룹_애디슨_공통';
  } else if (requestType === '채널링요청') {
    // 채널링 요청 시 숨겨진 필드 값을 '배너' 필드 이름으로 추가
    currentFormData['배너 표시 타입'] = '배너 이미지 ONLY';
    currentFormData['배너 그룹'] = '배너그룹_애디슨_공통';
  }

  fieldOrder.forEach(key => {
    if (currentFormData[key]) {
        summaryHtml += `<tr><th>${key}</th><td>${currentFormData[key].replace(/\n/g, '<br>')}</td></tr>`;
    }
  });

  // 숨겨진 그룹 필드가 중복 표시되지 않도록 별도 처리
  const hiddenFieldsMap = {
      '팝업요청': ['팝업 그룹'],
      '배너요청': ['배너 그룹'],
      '채널링요청': ['배너 표시 타입', '배너 그룹']
  };

  if(hiddenFieldsMap[requestType]) {
    hiddenFieldsMap[requestType].forEach(key => {
        // 이미 fieldOrder에 의해 표시된 필드는 건너뜀
        if (!fieldOrder.includes(key) && currentFormData[key]) {
            summaryHtml += `<tr><th>${key}</th><td>${currentFormData[key].replace(/\n/g, '<br>')}</td></tr>`;
        }
    });
  }
  summaryHtml += '</table>';
  
  let modalTitle;
  const campaignName = currentFormData['캠페인명'];

  if (requestType === '팝업요청') {
    modalTitle = `[팝업 등록 요청] ${campaignName}`;
  } else if (requestType === '배너요청') {
    modalTitle = `[배너 등록 요청] ${campaignName}`;
  } else if (requestType === '채널링요청') {
    modalTitle = `[채널링 등록 요청] ${campaignName}`;
  } else {
    const d = new Date();
    const year = String(d.getFullYear()).slice(-2);
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    const today = `${year}${month}${day}`;
    modalTitle = `[기타 등록 요청] ${currentFormData['광고주명']}_${today}`;
  }

  document.getElementById('modalTitle').textContent = modalTitle;
  document.getElementById('modalSummary').innerHTML = summaryHtml;

  const finalSubmitBtn = document.getElementById('finalSubmitBtn');
  const newBtn = finalSubmitBtn.cloneNode(true);
  finalSubmitBtn.parentNode.replaceChild(newBtn, finalSubmitBtn);
  newBtn.addEventListener('click', submitOtherRequest);

  document.getElementById('confirmationModal').style.display = 'flex';
  window.addEventListener('keydown', handleEscapeForConfirmationModal);
}

function submitOtherRequest() {
   currentFormData.ccRecipients = document.getElementById('ccRecipients').value.trim();
  setLoading(true);
  closeConfirmationModal();
  google.script.run
    .withSuccessHandler(function(response) {
      setLoading(false);
      if (response.success) {
        showMessage(response.message, 'success');
        alert(response.message);
        document.getElementById('otherRequestForm').reset();
        document.getElementById('otherRequestSubformContainer').innerHTML = '';
      } else {
        showMessage(response.message, 'error');
      }
    })
    .withFailureHandler(handleError)
    .submitOtherRequest(currentFormData);
}



function openCxRequestModal() {
  const form = document.getElementById('cxRequestForm');
  if (!form.checkValidity()) {
    showMessage('요청 내용을 입력해주세요.', 'error');
    form.reportValidity();
    return;
  }

  currentFormData = {};
  const formData = new FormData(form);
  const rawContent = formData.get('요청 내용');
  currentFormData['요청 내용'] = rawContent;

  // 1. 특수문자 이스케이프 처리 (<, > 등)
  let displayContent = rawContent
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");

  // 2. URL을 하이퍼링크로 변환 (정규식 사용)
  const urlRegex = /(https?:\/\/[^\s]+)/g;
  displayContent = displayContent.replace(urlRegex, '<a href="$1" target="_blank" style="color:#007bff;">$1</a>');

  // 3. 줄바꿈 처리
  displayContent = displayContent.replace(/\n/g, '<br>');

  // 4. 날짜 기반 제목 미리보기 생성 (클라이언트 예측)
  const today = new Date();
  const yy = String(today.getFullYear()).slice(-2);
  const mm = String(today.getMonth() + 1).padStart(2, '0');
  const dd = String(today.getDate()).padStart(2, '0');
  const previewTitle = `[애디슨오퍼월_광고생성요청] CS지급용 광고 생성요청_${yy}${mm}${dd} (순번은 서버에서 자동 부여)`;

  let summaryHtml = '<table>';
  summaryHtml += `<tr><th>자동 생성 제목</th><td>${previewTitle}</td></tr>`;
  summaryHtml += `<tr><th>요청 내용</th><td style="white-space: pre-wrap;">${displayContent}</td></tr>`;
  summaryHtml += '</table>';

  document.getElementById('modalTitle').textContent = 'CX팀 요청 확인';
  document.getElementById('modalSummary').innerHTML = summaryHtml;

  const finalSubmitBtn = document.getElementById('finalSubmitBtn');
  const newBtn = finalSubmitBtn.cloneNode(true);
  finalSubmitBtn.parentNode.replaceChild(newBtn, finalSubmitBtn);
  newBtn.addEventListener('click', submitCxRequest_client);

  document.getElementById('confirmationModal').style.display = 'flex';
  window.addEventListener('keydown', handleEscapeForConfirmationModal);
}

function submitCxRequest_client() {
  currentFormData.ccRecipients = document.getElementById('ccRecipients').value.trim();
  setLoading(true);
  closeConfirmationModal();

  google.script.run
    .withSuccessHandler(function(response) {
      setLoading(false);
      if (response.success) {
        showMessage(response.message, 'success');
        alert(response.message);
        document.getElementById('cxRequestForm').reset();
      } else {
        showMessage(response.message, 'error');
      }
    })
    .withFailureHandler(handleError)
    .submitCxRequest(currentFormData);
}

async function openBdRequestModal() {
  const form = document.getElementById('bdRequestForm'); // form ID가 bdRequestForm인지 확인
  // form 내부의 input 요소들을 찾기 위해 querySelector 사용
  const titleInput = form.querySelector('input[name="요청제목"]');
  const contentInput = form.querySelector('textarea[name="요청내용"]');
  
  if (!titleInput.value.trim() || !contentInput.value.trim()) {
    showMessage('요청 제목과 내용을 모두 입력해주세요.', 'error');
    return;
  }

  setLoading(true); // 파일 처리 중 로딩 표시

  currentFormData = {};
  currentFormData['요청제목'] = titleInput.value;
  currentFormData['요청내용'] = contentInput.value;

  // 파일 처리 (Base64 변환)
  const fileInput = form.querySelector('input[name="attachments"]');
  const files = Array.from(fileInput.files);
  const processedFiles = [];

  if (files.length > 0) {
    try {
      for (const file of files) {
        const base64Data = await readFileAsBase64(file);
        processedFiles.push({
          name: file.name,
          type: file.type,
          data: base64Data
        });
      }
    } catch (e) {
      setLoading(false);
      alert("파일 처리 중 오류가 발생했습니다.");
      return;
    }
  }
  // 서버로 전송하기 위해 JSON 문자열로 변환하여 저장
  currentFormData['attachments_json'] = JSON.stringify(processedFiles);

  setLoading(false);

  // 1. 내용 표시 처리 (HTML 이스케이프 + URL 링크)
  let displayContent = currentFormData['요청내용']
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
  
  const urlRegex = /(https?:\/\/[^\s]+)/g;
  displayContent = displayContent.replace(urlRegex, '<a href="$1" target="_blank" style="color:#007bff;">$1</a>');
  displayContent = displayContent.replace(/\n/g, '<br>');

  // 2. 제목 생성
  const today = new Date();
  const yy = String(today.getFullYear()).slice(-2);
  const mm = String(today.getMonth() + 1).padStart(2, '0');
  const dd = String(today.getDate()).padStart(2, '0');
  const previewTitle = `[오퍼월사업팀_요청] ${currentFormData['요청제목']}_${yy}${mm}${dd}`;

  // 3. 모달 내용 구성
  let summaryHtml = '<table>';
  summaryHtml += `<tr><th style="width:30%">자동 생성 제목</th><td>${previewTitle}</td></tr>`;
  summaryHtml += `<tr><th>요청 제목</th><td>${currentFormData['요청제목']}</td></tr>`;
  summaryHtml += `<tr><th>요청 내용</th><td style="white-space: pre-wrap;">${displayContent}</td></tr>`;
  
  if (processedFiles.length > 0) {
    const fileNames = processedFiles.map(f => f.name).join('<br>');
    summaryHtml += `<tr><th>첨부 파일 (${processedFiles.length}개)</th><td>${fileNames}</td></tr>`;
  } else {
    summaryHtml += `<tr><th>첨부 파일</th><td>없음</td></tr>`;
  }
  summaryHtml += '</table>';

  document.getElementById('modalTitle').textContent = '오퍼월사업팀 요청 확인';
  document.getElementById('modalSummary').innerHTML = summaryHtml;

  const finalSubmitBtn = document.getElementById('finalSubmitBtn');
  const newBtn = finalSubmitBtn.cloneNode(true);
  finalSubmitBtn.parentNode.replaceChild(newBtn, finalSubmitBtn);
  newBtn.addEventListener('click', submitBdRequest_client);

  document.getElementById('confirmationModal').style.display = 'flex';
  window.addEventListener('keydown', handleEscapeForConfirmationModal);
}

// 파일 읽기 헬퍼 함수
function readFileAsBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => {
      // data:image/png;base64, 부분 제거하고 순수 데이터만 추출
      const result = reader.result;
      const base64 = result.split(',')[1];
      resolve(base64);
    };
    reader.onerror = error => reject(error);
    reader.readAsDataURL(file);
  });
}

function submitBdRequest_client() {
  currentFormData.ccRecipients = document.getElementById('ccRecipients').value.trim();
  setLoading(true);
  closeConfirmationModal();

  google.script.run
    .withSuccessHandler(function(response) {
      setLoading(false);
      if (response.success) {
        showMessage(response.message, 'success');
        alert(response.message);
        // 폼 초기화 (빌더 함수 재호출이 가장 깔끔함)
        buildBdRequestForm(); 
      } else {
        showMessage(response.message, 'error');
      }
    })
    .withFailureHandler(handleError)
    .submitBdRequest(currentFormData);
}



</script>